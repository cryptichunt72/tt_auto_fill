<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Invoice Generator Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Fallback CSS for @apply (so CDN works without a build step) */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

    .card {
      background:#fff; border:1px solid #f3f4f6; border-radius:1rem;
      padding:1.5rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1);
      transition:box-shadow .2s ease, transform .2s ease;
    }
    .card:hover { box-shadow:0 25px 50px -12px rgba(0,0,0,.25); }
    .card-header { border-bottom:1px solid #f3f4f6; padding-bottom:1rem; margin-bottom:1.5rem; }

    .label { display:block; font-size:.875rem; font-weight:600; color:#374151; margin-bottom:.5rem; }

    .input {
      width:100%; border:1px solid #d1d5db; border-radius:.75rem; padding:.75rem 1rem;
      color:#111827; transition:border-color .2s ease, box-shadow .2s ease;
    }
    .input::placeholder { color:#6b7280; }
    .input:hover { border-color:#9ca3af; }
    .input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.3); }

    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:.75rem; padding:.75rem 1.5rem; font-weight:600;
      transition:transform .2s ease, box-shadow .2s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .btn:hover { transform:scale(1.05); box-shadow:0 4px 6px rgba(0,0,0,.08); }
    .btn:active { transform:scale(.97); }
    .btn-primary {
      background:linear-gradient(to right,#2563eb,#1d4ed8); color:#fff;
      box-shadow:0 10px 15px -3px rgba(29,78,216,.3),0 4px 6px -4px rgba(29,78,216,.3);
    }
    .btn-primary:hover { background:linear-gradient(to right,#1d4ed8,#1e40af); }
    .btn-secondary { background:#f3f4f6; color:#374151; border:1px solid #d1d5db; }
    .btn-secondary:hover { background:#e5e7eb; }
    .btn-success { background:linear-gradient(to right,#16a34a,#15803d); color:#fff; }
    .btn-warning { background:linear-gradient(to right,#f59e0b,#d97706); color:#fff; }
    .btn-danger  { background:linear-gradient(to right,#ef4444,#dc2626); color:#fff; }

    .pill { font-size:.75rem; background:#dbeafe; color:#1e40af; padding:.25rem .75rem; border-radius:9999px; font-weight:500; }

    .grid-2 { display:grid; grid-template-columns:1fr; gap:1.5rem; }
    @media (min-width:1024px){ .grid-2 { grid-template-columns:repeat(2, minmax(0,1fr)); } }
    .grid-3 { display:grid; grid-template-columns:1fr; gap:1rem; }
    @media (min-width:768px){ .grid-3 { grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (min-width:1024px){ .grid-3 { grid-template-columns:repeat(3, minmax(0,1fr)); } }
    .grid-4 { display:grid; grid-template-columns:1fr; gap:1rem; }
    @media (min-width:768px){ .grid-4 { grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (min-width:1024px){ .grid-4 { grid-template-columns:repeat(4, minmax(0,1fr)); } }

    .section-title { font-size:1.25rem; font-weight:700; color:#1f2937; margin-bottom:.5rem; display:flex; align-items:center; gap:.75rem; }
    .section-subtitle { font-size:.875rem; color:#4b5563; margin-bottom:1rem; }

    .loading { animation:spin 1s linear infinite; border-radius:9999px; height:1rem; width:1rem; border:2px solid #fff; border-top-color:transparent; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .fade-in { animation: fadeIn .3s ease-in-out; }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .item-row {
      background:#f9fafb; border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem; margin-bottom:1rem;
      transition: background .2s ease;
    }
    .item-row:hover { background:#f3f4f6; }

    .status-indicator { display:inline-flex; align-items:center; padding:.125rem .625rem; border-radius:9999px; font-size:.75rem; font-weight:500; }
    .status-success { background:#dcfce7; color:#166534; }
    .status-warning { background:#fef9c3; color:#854d0e; }
    .status-error   { background:#fee2e2; color:#991b1b; }

    .hero-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass-effect { backdrop-filter: blur(10px); background: rgba(255,255,255,0.9); }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-6 space-y-8">
    <!-- Enhanced Header -->
    <header class="hero-gradient rounded-3xl p-8 text-white relative overflow-hidden">
      <div class="absolute inset-0 bg-black opacity-10"></div>
      <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <div class="bg-white bg-opacity-20 p-3 rounded-2xl">
              <i class="fas fa-file-invoice text-2xl"></i>
            </div>
            <div>
              <h1 class="text-3xl font-bold">Invoice Generator Pro</h1>
              <p class="text-blue-100 text-lg">Professional invoice creation made simple</p>
            </div>
          </div>
          <div class="text-right">
            <div class="status-indicator bg-white bg-opacity-20 text-white mb-2">
              <i class="fas fa-database mr-2"></i>
              <span id="companyCount">0 companies</span>
            </div>
            <p class="text-blue-100 text-sm">Templates saved locally</p>
          </div>
        </div>
      </div>
    </header>

    <!-- =================== NEW: Auto-Generate Items (Gemini) =================== -->
    <div class="card fade-in">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-wand-magic-sparkles text-indigo-600"></i>
          Auto-Generate Items (Gemini)
        </h2>
        <p class="section-subtitle">
          Enter a company and a target total; we’ll research what they do and propose invoice items you can paste below.
        </p>
      </div>

      <div class="grid-3 items-end gap-6">
        <div>
          <label class="label"><i class="fas fa-building mr-2"></i>Company</label>
          <input id="gen_company" class="input" placeholder="e.g., Clair Electronics Private Limited">
        </div>
        <div>
          <label class="label"><i class="fas fa-sack-dollar mr-2"></i>Total</label>
          <input id="gen_total" class="input" placeholder="e.g., 100000">
        </div>
        <div>
          <label class="label"><i class="fas fa-globe mr-2"></i>Currency</label>
          <input id="gen_currency" class="input" value="INR" placeholder="USD / INR">
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-4">
        <button type="button" class="btn btn-secondary" id="genItemsBtn">
          <i class="fas fa-wand-magic-sparkles mr-2"></i>
          Generate with Gemini
        </button>
        <span class="pill" id="genStatus" style="display:none;">Working…</span>
      </div>

      <div class="mt-4">
        <label class="label"><i class="fas fa-clipboard mr-2"></i>Generated (copy below or auto-fill)</label>
        <textarea id="gen_output" class="input" rows="8"
          placeholder="Generated text will appear here, ready to paste into the box below."></textarea>
        <div class="flex gap-2 mt-3">
          <button type="button" class="btn btn-primary" id="copyToPasteBtn">
            <i class="fas fa-arrow-down mr-2"></i> Copy to “Paste Invoice Data”
          </button>
          <button type="button" class="btn btn-success" id="applyToFormBtn" title="Fill the item rows directly">
            <i class="fas fa-list-check mr-2"></i> Fill Items in Form
          </button>
        </div>
      </div>
    </div>
    <!-- =================== /NEW: Auto-Generate Items (Gemini) =================== -->

    <!-- Enhanced PASTE & PARSE Section -->
    <div class="card fade-in">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-magic text-blue-600"></i>
          Smart Data Extraction
        </h2>
        <p class="section-subtitle">Paste your invoice data and let AI extract the information automatically</p>
      </div>

      <div class="space-y-4">
        <div>
          <label class="label">
            <i class="fas fa-paste mr-2"></i>
            Paste Invoice Data
          </label>
          <textarea
            id="pasteBox"
            class="input"
            rows="8"
            placeholder="Paste your invoice details here...&#10;&#10;Example:&#10;PI No: FTP2025001&#10;Date: Jan 15, 2025&#10;Buyer: ABC Company&#10;Items: - SKU001; LED Light; Qty 100; Rate 25.50"
          ></textarea>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="button" class="btn btn-secondary" id="parseBtn">
            <i class="fas fa-cogs mr-2"></i>
            Smart Parse
          </button>
          <button type="button" class="btn btn-primary" id="llmParseBtn">
            <i class="fas fa-brain mr-2"></i>
            AI Extract
          </button>
          <button type="button" class="btn btn-warning" id="clearPasteBtn">
            <i class="fas fa-eraser mr-2"></i>
            Clear
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
            <div>
              <h4 class="font-semibold text-blue-900 mb-2">Supported Formats:</h4>
              <ul class="text-sm text-blue-800 space-y-1">
                <li>• Labels: "PI No, Date, POL, POD, Buyer/Notify, Category"</li>
                <li>• Items: "- CODE; Description; Qty N; Rate R"</li>
                <li>• Bank details: "Account Name, Account No, SWIFT"</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced COMPANY PICKER -->
    <div class="card fade-in">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-building text-green-600"></i>
          Company Management
        </h2>
        <p class="section-subtitle">Select an existing company template or create a new one</p>
      </div>

      <div class="grid-3 items-end gap-6">
        <div>
          <label class="label">
            <i class="fas fa-list mr-2"></i>
            Choose Existing Company
          </label>
          <select id="companySelect" class="input">
            <option value="">— Select company —</option>
          </select>
        </div>
        <div>
          <label class="label">
            <i class="fas fa-plus mr-2"></i>
            Or Type New Company Name
          </label>
          <input
            id="company_name"
            name="company_name"
            class="input"
            placeholder="Enter company name..."
          />
        </div>
        <div class="flex gap-2">
          <button class="btn btn-success" id="loadTemplateBtn" title="Loads the template for selected company">
            <i class="fas fa-download mr-2"></i>
            Load Template
          </button>
          <button class="btn btn-danger" id="clearBtn">
            <i class="fas fa-trash mr-2"></i>
            Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced FORM -->
    <form id="invoiceForm" class="space-y-8">
      <!-- Company & Meta Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-info-circle text-purple-600"></i>
            Company & Invoice Details
          </h2>
          <p class="section-subtitle">Basic company information and invoice metadata</p>
        </div>

        <div class="grid-2 gap-6">
          <div>
            <label class="label">
              <i class="fas fa-map-marker-alt mr-2"></i>
              Company Address
            </label>
            <textarea
              class="input"
              id="company_addr"
              name="company_addr"
              rows="4"
              placeholder="Enter your company address..."
            ></textarea>
          </div>
          <div class="space-y-4">
            <div class="grid-2 gap-4">
              <div>
                <label class="label">
                  <i class="fas fa-tag mr-2"></i>
                  Invoice Title
                </label>
                <input
                  class="input"
                  id="title"
                  name="title"
                  value="PROFORMA INVOICE"
                  placeholder="Invoice title..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-hashtag mr-2"></i>
                  PI Number
                </label>
                <input
                  class="input"
                  id="pi_no"
                  name="pi_no"
                  placeholder="FTP2025XXXX"
                />
              </div>
            </div>
            <div class="grid-2 gap-4">
              <div>
                <label class="label">
                  <i class="fas fa-calendar mr-2"></i>
                  Date
                </label>
                <input
                  class="input"
                  id="date"
                  name="date"
                  placeholder="JAN.04,2025"
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-shipping-fast mr-2"></i>
                  Shipment Method
                </label>
                <input
                  class="input"
                  id="shipment"
                  name="shipment"
                  placeholder="VIA SEA"
                />
              </div>
            </div>
            <div class="grid-2 gap-4">
              <div>
                <label class="label">
                  <i class="fas fa-anchor mr-2"></i>
                  Port of Loading
                </label>
                <input
                  class="input"
                  id="port_loading"
                  name="port_loading"
                  placeholder="CHINA"
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-map-pin mr-2"></i>
                  Port of Discharge
                </label>
                <input
                  class="input"
                  id="port_discharge"
                  name="port_discharge"
                  placeholder="CHENNAI, INDIA"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buyer & Notify Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-users text-indigo-600"></i>
            Buyer & Notify Party
          </h2>
          <p class="section-subtitle">Customer and notification party information</p>
        </div>

        <div class="grid-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="label">
                <i class="fas fa-user mr-2"></i>
                Buyer Name
              </label>
              <input
                class="input"
                id="buyer_name"
                name="buyer_name"
                placeholder="Enter buyer company name..."
              />
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt mr-2"></i>
                Buyer Address
              </label>
              <textarea
                class="input"
                id="buyer_addr"
                name="buyer_addr"
                rows="4"
                placeholder="Enter buyer address..."
              ></textarea>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <label class="label">
                <i class="fas fa-bell mr-2"></i>
                Notify Party Name
              </label>
              <input
                class="input"
                id="notify_name"
                name="notify_name"
                placeholder="Enter notify party name..."
              />
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt mr-2"></i>
                Notify Party Address
              </label>
              <textarea
                class="input"
                id="notify_addr"
                name="notify_addr"
                rows="4"
                placeholder="Enter notify party address..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-tags text-orange-600"></i>
            Product Category
          </h2>
          <p class="section-subtitle">Specify the category of products being invoiced</p>
        </div>

        <div>
          <label class="label">
            <i class="fas fa-folder mr-2"></i>
            Category
          </label>
          <input
            class="input"
            id="category"
            name="category"
            placeholder="LED LIGHTING FIXTURES AND SPARES"
          />
        </div>
      </div>

      <!-- Items Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-list-alt text-teal-600"></i>
            Invoice Items
          </h2>
          <p class="section-subtitle">Add products or services to your invoice</p>
        </div>

        <div id="items" class="space-y-4"></div>

        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
          <button type="button" class="btn btn-primary" id="addItemBtn">
            <i class="fas fa-plus mr-2"></i>
            Add Item
          </button>
          <div class="text-sm text-gray-500">
            <i class="fas fa-info-circle mr-1"></i>
            Click "Add Item" to add products or services
          </div>
        </div>
      </div>

      <!-- Totals & Bank Section -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="section-title">
            <i class="fas fa-calculator text-red-600"></i>
            Totals & Banking Information
          </h2>
          <p class="section-subtitle">Final amounts and payment details</p>
        </div>

        <div class="grid-2 gap-6">
          <div>
            <label class="label">
              <i class="fas fa-dollar-sign mr-2"></i>
              Total Amount
            </label>
            <input
              class="input text-lg font-semibold"
              id="total"
              name="total"
              placeholder="100000.00"
            />
          </div>
          <div class="space-y-4">
            <div class="grid-2 gap-4">
              <div>
                <label class="label">
                  <i class="fas fa-user mr-2"></i>
                  Account Holder Name
                </label>
                <input
                  class="input"
                  id="bank_account_name"
                  placeholder="Account holder name..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-credit-card mr-2"></i>
                  Account Number
                </label>
                <input
                  class="input"
                  id="bank_account_no"
                  placeholder="Account number..."
                />
              </div>
            </div>
            <div class="grid-2 gap-4">
              <div>
                <label class="label">
                  <i class="fas fa-university mr-2"></i>
                  Bank Name
                </label>
                <input
                  class="input"
                  id="bank_name"
                  placeholder="Bank name..."
                />
              </div>
              <div>
                <label class="label">
                  <i class="fas fa-code mr-2"></i>
                  SWIFT Code
                </label>
                <input
                  class="input"
                  id="bank_swift"
                  placeholder="SWIFT code..."
                />
              </div>
            </div>
            <div>
              <label class="label">
                <i class="fas fa-map-marker-alt mr-2"></i>
                Account Holder Address
              </label>
              <textarea
                class="input"
                id="bank_account_addr"
                rows="2"
                placeholder="Account holder address..."
              ></textarea>
            </div>
            <div>
              <label class="label">
                <i class="fas fa-building mr-2"></i>
                Bank Branch Address
              </label>
              <textarea
                class="input"
                id="bank_addr"
                rows="2"
                placeholder="Bank branch address..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card fade-in">
        <div class="flex flex-wrap gap-4 justify-center">
          <button type="button" class="btn btn-primary text-lg px-8 py-4" id="generateBtn">
            <i class="fas fa-file-pdf mr-3"></i>
            Generate Invoice
          </button>
          <button type="button" class="btn btn-success text-lg px-8 py-4" id="saveTemplateBtn" title="Saves/updates template for current company">
            <i class="fas fa-save mr-3"></i>
            Save Template
          </button>
        </div>
      </div>
    </form>

    <!-- Enhanced Result Section -->
    <div id="result" class="hidden card fade-in">
      <div class="card-header">
        <h2 class="section-title">
          <i class="fas fa-check-circle text-green-600"></i>
          Result
        </h2>
      </div>
      <div id="resultBody" class="text-gray-700"></div>
    </div>
  </div>

<script>
"use strict";

function $(id){ return document.getElementById(id); }
function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

const API_BASE = "/invoice/api";   // <<<<<<<<<< IMPORTANT

/* ----------------- Gemini Auto-Generate handlers ----------------- */
async function generateWithGemini(){
  const company = $('gen_company')?.value?.trim();
  const total   = $('gen_total')?.value?.trim();
  const currency= $('gen_currency')?.value?.trim() || 'USD';
  const status  = $('genStatus');
  const outBox  = $('gen_output');

  if(!company || !total){
    showResult('Enter company and total first.');
    return;
  }

  try{
    if(status){ status.style.display='inline-flex'; status.textContent='Working…'; }

    const res = await fetch(API_BASE + '/suggest_items_text', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ company_name: company, total, currency, n_items: 6 })
    });

    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if(outBox) outBox.value = data.text || '';
    showResult('✅ Generated items.');
  }catch(e){
    showResult('Gemini error: ' + e.message);
  }finally{
    if(status) status.style.display='none';
  }
}

function copyGenToPaste(){
  const src = $('gen_output'), dst = $('pasteBox');
  if(!src || !dst){ showResult('Missing boxes'); return; }
  dst.value = src.value || '';
  showResult('Copied to “Paste Invoice Data”.');
}

async function applyGenToForm(){
  const company = $('gen_company')?.value?.trim();
  const total   = $('gen_total')?.value?.trim();
  const currency= $('gen_currency')?.value?.trim() || 'USD';

  if(!company || !total){
    showResult('Enter company and total first.');
    return;
  }

  try{
    const res = await fetch(API_BASE + '/suggest_items', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ company_name: company, total, currency, n_items: 6 })
    });

    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();

    const itemsWrap = $('items');
    if(itemsWrap) itemsWrap.innerHTML = '';

    (data.items || []).forEach((it,i)=> addItem(it, i+1));

    if($('total')) $('total').value = data.total || total;

    showResult('✅ Filled items in the form.');
  }catch(e){
    showResult('Apply items error: ' + e.message);
  }
}

/* ----------------- Invoice item rows ----------------- */
const itemRowHTML = () => `
  <div class="item-row fade-in">
    <div class="grid grid-cols-12 gap-4 items-end">
      <div class="col-span-1">
        <label class="label text-xs">SL.NO</label>
        <input class="input it-slno text-center" />
      </div>
      <div class="col-span-3">
        <label class="label text-xs">ITEM NO.</label>
        <input class="input it-itemno" placeholder="SKU-0001"/>
      </div>
      <div class="col-span-4">
        <label class="label text-xs">DESCRIPTION</label>
        <input class="input it-desc" placeholder="Product Description"/>
      </div>
      <div class="col-span-1">
        <label class="label text-xs">QTY</label>
        <input class="input it-qty text-center" value="1"/>
      </div>
      <div class="col-span-1">
        <label class="label text-xs">UNIT</label>
        <input class="input it-unit text-center" value="NOS"/>
      </div>
      <div class="col-span-1">
        <label class="label text-xs">RATE</label>
        <input class="input it-rate text-right" value="0.00"/>
      </div>
      <div class="col-span-1">
        <label class="label text-xs">AMOUNT</label>
        <input class="input it-amount text-right font-semibold" value="0.00"/>
      </div>
    </div>
    <div class="flex justify-end mt-3 pt-3 border-t border-gray-200">
      <button type="button" class="btn btn-danger btn-sm removeItemBtn">
        <i class="fas fa-trash mr-2"></i>
        Remove Item
      </button>
    </div>
  </div>
`;

function addItem(prefill=null, index=null){
  const list = $('items');
  list.insertAdjacentHTML('beforeend', itemRowHTML());

  const row = qsa('.item-row', list).at(-1);
  const set = (sel, v) => { const el=row.querySelector(sel); if (el && v!=null) el.value = v; };

  const i = index ?? qsa('.item-row', list).length;
  set('.it-slno', prefill?.slno ?? String(i));
  set('.it-itemno', prefill?.item_no ?? 'SKU-0001');
  set('.it-desc', prefill?.description ?? 'Product Description');
  set('.it-qty', prefill?.quantity ?? '1');
  set('.it-unit', prefill?.unit ?? 'NOS');
  set('.it-rate', prefill?.rate ?? '0.00');
  set('.it-amount', prefill?.amount ?? '0.00');

  row.querySelector('.removeItemBtn').addEventListener('click', () => row.remove());
}

/* ----------------- Form collect & fill ----------------- */
function collectForm() {
  const items = qsa('.item-row').map((row, i) => ({
    slno: row.querySelector('.it-slno')?.value || String(i+1),
    item_no: row.querySelector('.it-itemno')?.value || '',
    description: row.querySelector('.it-desc')?.value || '',
    quantity: row.querySelector('.it-qty')?.value || '',
    unit: row.querySelector('.it-unit')?.value || '',
    rate: row.querySelector('.it-rate')?.value || '',
    amount: row.querySelector('.it-amount')?.value || ''
  }));

  return {
    company_name: $('company_name')?.value || $('companySelect')?.value || '',
    company_addr: $('company_addr')?.value || '',
    title: $('title')?.value || 'PROFORMA INVOICE',
    pi_no: $('pi_no')?.value || '',
    date: $('date')?.value || '',
    shipment: $('shipment')?.value || '',
    port_loading: $('port_loading')?.value || '',
    port_discharge: $('port_discharge')?.value || '',
    buyer_name: $('buyer_name')?.value || '',
    buyer_addr: $('buyer_addr')?.value || '',
    notify_name: $('notify_name')?.value || '',
    notify_addr: $('notify_addr')?.value || '',
    category: $('category')?.value || '',
    items,
    total: $('total')?.value || '',
    bank: {
      account_name: $('bank_account_name')?.value || '',
      account_addr: $('bank_account_addr')?.value || '',
      account_no: $('bank_account_no')?.value || '',
      bank_name: $('bank_name')?.value || '',
      bank_addr: $('bank_addr')?.value || '',
      swift: $('bank_swift')?.value || ''
    }
  };
}

function fillForm(d){
  const safe = (k, v) => { const el=$(k); if (el) el.value = v ?? ''; };

  safe('company_name', d.company_name);
  safe('company_addr', d.company_addr);
  safe('title', d.title);
  safe('pi_no', d.pi_no);
  safe('date', d.date);
  safe('shipment', d.shipment);
  safe('port_loading', d.port_loading);
  safe('port_discharge', d.port_discharge);
  safe('buyer_name', d.buyer_name);
  safe('buyer_addr', d.buyer_addr);
  safe('notify_name', d.notify_name);
  safe('notify_addr', d.notify_addr);
  safe('category', d.category);
  safe('total', d.total);

  const bank = d.bank || {};
  safe('bank_account_name', bank.account_name);
  safe('bank_account_addr', bank.account_addr);
  safe('bank_account_no', bank.account_no);
  safe('bank_name', bank.bank_name);
  safe('bank_addr', bank.bank_addr);
  safe('bank_swift', bank.swift);

  $('items').innerHTML = '';
  (d.items || []).forEach((it,i)=> addItem(it, i+1));
  if(!d.items?.length) addItem(null, 1);
}

/* ----------------- Backend calls ----------------- */
async function loadCompanies(){
  try {
    const res = await fetch(API_BASE + '/companies');
    const data = await res.json();

    const sel = $('companySelect');
    sel.innerHTML = '<option value="">— Select company —</option>';

    data.pretty.forEach((name, i)=>{
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    $('companyCount').textContent = data.pretty.length + ' companies';
  } catch(e){
    console.error("Load companies error", e);
  }
}

async function fetchTemplateForSelected(){
  const name = $('companySelect')?.value;
  if(!name) return;

  try{
    const res = await fetch(API_BASE + '/template?name=' + encodeURIComponent(name));
    const data = await res.json();
    fillForm(data);
    $('company_name').value = name;
  }catch(e){
    showResult("Error loading template: " + e.message);
  }
}

async function saveTemplate(){
  try{
    const res = await fetch(API_BASE + '/save_template', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(collectForm())
    });

    const d = await res.json();
    showResult(d.message);
    loadCompanies();
  }catch(e){
    showResult("Save error: " + e.message);
  }
}

async function generateInvoice(){
  try{
    const res = await fetch(API_BASE + '/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(collectForm())
    });

    const d = await res.json();
    showResult(`Saved: <a class="text-blue-600 underline" target="_blank" href="${d.download_url}">${d.filename}</a>`);
  }catch(e){
    showResult("Generate error: " + e.message);
  }
}

async function parseAndFill(){
  const txt = $('pasteBox').value.trim();
  if(!txt) return showResult("Paste something first");

  try{
    const res = await fetch(API_BASE + '/parse_paste', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text: txt })
    });

    const d = await res.json();
    fillForm(d);
    showResult("Parsed and filled.");
  }catch(e){
    showResult("Parse error: " + e.message);
  }
}

async function llmParseAndFill(){
  const txt = $('pasteBox').value.trim();
  if(!txt) return showResult("Paste something first");

  try{
    const res = await fetch(API_BASE + '/llm_extract', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text: txt })
    });

    const d = await res.json();
    fillForm(d);
    showResult("LLM extracted and filled.");
  }catch(e){
    showResult("LLM error: " + e.message);
  }
}

/* ----------------- Result display ----------------- */
function showResult(html){
  $('resultBody').innerHTML = html;
  $('result').classList.remove('hidden');
}

/* ----------------- Bind buttons ----------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  loadCompanies();
  addItem(null, 1);

  $('genItemsBtn')?.addEventListener('click', generateWithGemini);
  $('copyToPasteBtn')?.addEventListener('click', copyGenToPaste);
  $('applyToFormBtn')?.addEventListener('click', applyGenToForm);

  $('addItemBtn').addEventListener('click', () => addItem());
  $('loadTemplateBtn').addEventListener('click', fetchTemplateForSelected);
  $('saveTemplateBtn').addEventListener('click', saveTemplate);
  $('generateBtn').addEventListener('click', generateInvoice);

  $('parseBtn').addEventListener('click', parseAndFill);
  $('llmParseBtn').addEventListener('click', llmParseAndFill);
  $('clearPasteBtn').addEventListener('click', () => $('pasteBox').value = '');
  $('clearBtn').addEventListener('click', () => fillForm({ items: [] }));
});
</script>

</body>
</html>
