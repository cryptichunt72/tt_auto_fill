<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TT Form Autofill</title>

  <style>
    :root{
      --bg: #0b0c10;
      --panel: #14161a;
      --panel-2: #171a1f;
      --text: #e8ebf0;
      --muted: #aab3c0;
      --primary: #4f8cff;
      --primary-600: #3a73df;
      --border: #262a31;
      --accent: #2a2f39;
      --success: #14b87a;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* Page */
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 500px at 10% -10%, #1d2331 0%, transparent 50%),
                  radial-gradient(1200px 600px at 110% -20%, #1a2336 0%, transparent 45%),
                  var(--bg);
      color: var(--text);
      font: 16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .container{
      max-width: 1180px;
      margin: 32px auto 120px;
      padding: 0 20px;
    }

    /* Header */
    .app-title{
      margin: 0 0 20px;
      letter-spacing: .3px;
      font-weight: 700;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .badge{
      font-size: 12px; letter-spacing: .4px;
      color: #9ec0ff; background: #1a2950; border: 1px solid #233a75;
      padding: 4px 8px; border-radius: 999px;
    }

    /* Grid */
    .grid{ display: grid; gap: 22px; }
    .grid-2{ grid-template-columns: 1fr 1fr; }
    @media (max-width: 920px){ .grid-2{ grid-template-columns: 1fr; } }

    /* Cards */
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h3{
      margin: 2px 0 14px;
      font-size: 18px; letter-spacing: .2px;
    }

    /* Form */
    .row{ display: grid; gap: 12px; }
    .row-2{ grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .row-2{ grid-template-columns: 1fr; } }

    label{
      font-size: 12.5px; color: var(--muted); letter-spacing: .35px;
      margin: 8px 0 4px; display: block;
    }
    input, select, textarea{
      width: 100%;
      box-sizing: border-box;
      background: #101319;
      color: var(--text);
      border: 1px solid var(--border);
      outline: none;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      transition: border-color .2s, box-shadow .2s, background .2s;
    }
    input:focus, select:focus, textarea:focus{
      border-color: #355fb8;
      box-shadow: 0 0 0 3px rgba(79,140,255,.18);
      background: #0f1218;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .divider{
      height: 1px; background: var(--border); margin: 12px 0 10px;
    }
    .section-title{
      margin: 6px 0 8px;
      font-size: 13px; letter-spacing: .45px; color: #cbd5e1;
      text-transform: uppercase;
    }

    /* Action bar (sticky footer) */
    .actions{
      position: fixed; inset: auto 0 16px;
      display: flex; justify-content: center;
      pointer-events: none;
    }
    .actions-inner{
      pointer-events: all;
      display:flex; gap:12px; align-items:center;
      background: rgba(17,19,26,.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    button{
      appearance: none; cursor: pointer; border: 1px solid var(--border);
      color: var(--text); background: #0f1218;
      padding: 10px 14px; border-radius: 999px; font-weight: 600;
      letter-spacing: .2px;
    }
    .btn-primary{
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      border-color: #2c56c5; color: white;
    }
    .btn-ghost{ background: #12151c; }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-ghost:hover{ background: #161a22; }
    .hint{ color: var(--muted); font-size: 12.5px; margin: 6px 0 0; }

    /* Selects to look nicer */
    select{
      background-image: linear-gradient(45deg, transparent 50%, #8594b0 50%),
                        linear-gradient(135deg, #8594b0 50%, transparent 50%),
                        linear-gradient(to right, #101319, #101319);
      background-position: calc(100% - 18px) 16px, calc(100% - 13px) 16px, 100% 0;
      background-size: 5px 5px, 5px 5px, 2.5em 3.5em;
      background-repeat: no-repeat;
      padding-right: 42px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="app-title">
      TT Form Autofill
      <span class="badge">Notion ↔ DOCX</span>
    </h1>

    {% if env_error %}
      <div class="card" style="border-color:#7a1d2a;background:#1a1214;color:#ffd7dc">
        <strong>Environment error:</strong> {{ env_error }}
        <div class="hint">Fix your <code>.env</code>, then refresh.</div>
      </div>
    {% endif %}

    <div class="grid grid-2">
      <!-- Remitter -->
      <div class="card">
        <h3>Remitter</h3>
        <div class="row">
          <label>Choose</label>
          <select id="remitterSelect"></select>
          <button class="btn-ghost" id="newRemitterBtn">+ New Remitter</button>
        </div>

        <div class="divider"></div>
        <div id="remitterForm" class="row"></div>
      </div>

      <!-- Beneficiary -->
      <div class="card">
        <h3>Beneficiary</h3>
        <div class="row">
          <label>Choose</label>
          <select id="beneficiarySelect"></select>
          <button class="btn-ghost" id="newBeneficiaryBtn">+ New Beneficiary</button>
        </div>

        <div class="divider"></div>
        <div id="beneficiaryForm" class="row"></div>
      </div>
    </div>

    <!-- TT Extras -->
    <div class="card" style="margin-top:22px;">
      <div class="section-title">TT Extras</div>
      <div class="row row-2">
        <div>
          <label for="ttDate">Date</label>
          <input id="ttDate" type="date" placeholder="yyyy-mm-dd" />
        </div>
        <div>
          <label for="ttCurrency">Currency</label>
          <input id="ttCurrency" placeholder="USD" value="USD" />
        </div>
        <div>
          <label for="ttAmount">Amount (figures)</label>
          <input id="ttAmount" placeholder="e.g. 18475.60" />
        </div>
        <div>
          <label for="ttCharges">Charges (OURS/SHA/BENEFICIARY)</label>
          <select id="ttCharges">
            <option value="SHA" selected>SHA</option>
            <option value="OURS">OURS</option>
            <option value="BENEFICIARY">BENEFICIARY</option>
          </select>
        </div>
        <div style="grid-column:1 / -1;">
          <label for="ttDebit">Account to be Debited (No &amp; Currency)</label>
          <input id="ttDebit" placeholder="012345678901 / HKD" />
        </div>
        <div style="grid-column:1 / -1;">
          <label for="ttNotes">Notes</label>
          <textarea id="ttNotes" placeholder="Invoice / shipment notes…"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticky action bar -->
  <div class="actions">
    <div class="actions-inner">
      <button class="btn-primary" id="saveButtons">Save/Update in Notion</button>
      <button class="btn-ghost" id="generateBtn">Download Filled DOCX</button>
    </div>
  </div>

  <script>
    /* ---------- UI Helpers & Rendering (IDs unchanged) ---------- */
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === "value") e.value = v;
        else if (k === "text") e.textContent = v;
        else e.setAttribute(k, v);
      }
      for (const c of children) e.appendChild(c);
      return e;
    }

    function remitterFields(data={}){
      return el("div", {class:"row"}, [
        el("div", {}, [ el("label",{text:"Name"}), el("input",{id:"r_name", value:data.name||"", placeholder:"Acme Pvt Ltd"}) ]),
        el("div", {}, [ el("label",{text:"Account No"}), el("input",{id:"r_account_no", value:data.account_no||"", placeholder:"0000 0000 0000"}) ]),
        el("div", {class:"row"}, [ el("label",{text:"Address"}), el("textarea",{id:"r_address", value:data.address||"", placeholder:"Street, City, ZIP, Country"}) ]),
        el("div", {class:"row row-2"}, [
          el("div", {}, [ el("label",{text:"Phone"}), el("input",{id:"r_phone", value:data.phone||"", placeholder:"+XX-XXXXX-XXXXX"}) ]),
          el("div", {}, [ el("label",{text:"ID Type"}), el("input",{id:"r_id_type", value:data.id_type||"", placeholder:"Passport / BRN / HKID"}) ])
        ]),
        el("div", {}, [ el("label",{text:"ID Value"}), el("input",{id:"r_id_value", value:data.id_value||"", placeholder:"ID number"}) ]),
        el("input",{id:"r_id", type:"hidden", value:data.id||""})
      ]);
    }

    function beneficiaryFields(data={}){
      return el("div", {class:"row"}, [
        el("div", {}, [ el("label",{text:"Beneficiary Name"}), el("input",{id:"b_beneficiary_name", value:data.beneficiary_name||"", placeholder:"Company / Person"}) ]),
        el("div", {}, [ el("label",{text:"Beneficiary Account Number"}), el("input",{id:"b_beneficiary_account_number", value:data.beneficiary_account_number||"", placeholder:"IBAN / Account No"}) ]),
        el("div", {}, [ el("label",{text:"Beneficiary Address"}), el("textarea",{id:"b_beneficiary_address", value:data.beneficiary_address||"", placeholder:"Street, City, ZIP"}) ]),
        el("div", {class:"row row-2"}, [
          el("div", {}, [ el("label",{text:"Beneficiary Country"}), el("input",{id:"b_beneficiary_country", value:data.beneficiary_country||"", placeholder:"e.g. USA"}) ]),
          el("div", {}, [ el("label",{text:"Beneficiary Bank Name"}), el("input",{id:"b_beneficiary_bank_name", value:data.beneficiary_bank_name||"", placeholder:"Bank name"}) ])
        ]),
        el("div", {class:"row row-2"}, [
          el("div", {}, [ el("label",{text:"Beneficiary Bank Address"}), el("input",{id:"b_beneficiary_bank_address", value:data.beneficiary_bank_address||"", placeholder:"Bank address"}) ]),
          el("div", {}, [ el("label",{text:"Beneficiary Bank Country"}), el("input",{id:"b_beneficiary_bank_country", value:data.beneficiary_bank_country||"", placeholder:"e.g. USA"}) ])
        ]),
        el("div", {class:"row row-2"}, [
          el("div", {}, [ el("label",{text:"Beneficiary Bank SWIFT"}), el("input",{id:"b_beneficiary_bank_swift", value:data.beneficiary_bank_swift||"", placeholder:"SWIFT/BIC"}) ]),
          el("div", {}, [ el("label",{text:"Intermediary Bank Name"}), el("input",{id:"b_intermediary_bank_name", value:data.intermediary_bank_name||"", placeholder:"(optional)"}) ])
        ]),
        el("div", {class:"row row-2"}, [
          el("div", {}, [ el("label",{text:"Intermediary Bank Address"}), el("input",{id:"b_intermediary_bank_address", value:data.intermediary_bank_address||"", placeholder:"(optional)"}) ]),
          el("div", {}, [ el("label",{text:"Intermediary Bank SWIFT"}), el("input",{id:"b_intermediary_bank_swift", value:data.intermediary_bank_swift||"", placeholder:"(optional)"}) ])
        ]),
        el("input",{id:"b_id", type:"hidden", value:data.id||""})
      ]);
    }

    async function loadOptions(){
      const r = await fetch("/api/options");
      const data = await r.json();

      const rs = document.getElementById("remitterSelect");
      rs.innerHTML = ""; rs.appendChild(el("option",{value:"",text:"-- Select Remitter --"}));
      data.remitters.forEach(x => rs.appendChild(el("option",{value:x.id, text:x.name||"(untitled)"})));

      const bs = document.getElementById("beneficiarySelect");
      bs.innerHTML = ""; bs.appendChild(el("option",{value:"",text:"-- Select Beneficiary --"}));
      data.beneficiaries.forEach(x => bs.appendChild(el("option",{value:x.id, text:x.name||"(untitled)"})));
    }

    async function onSelect(rtype, id){
      const formId = (rtype==="remitter") ? "remitterForm" : "beneficiaryForm";
      const wrap = document.getElementById(formId);
      if(!id){ wrap.innerHTML=""; return; }
      const r = await fetch(`/api/record/${rtype}/${id}`);
      const data = await r.json();
      wrap.innerHTML = "";
      wrap.appendChild(rtype==="remitter" ? remitterFields(data) : beneficiaryFields(data));
    }

    async function upsert(rtype){
      const payload = (rtype==="remitter") ? {
        id: document.getElementById("r_id")?.value || "",
        name: document.getElementById("r_name").value,
        account_no: document.getElementById("r_account_no").value,
        address: document.getElementById("r_address").value,
        phone: document.getElementById("r_phone").value,
        id_type: document.getElementById("r_id_type").value,
        id_value: document.getElementById("r_id_value").value
      } : {
        id: document.getElementById("b_id")?.value || "",
        beneficiary_name: document.getElementById("b_beneficiary_name").value,
        beneficiary_account_number: document.getElementById("b_beneficiary_account_number").value,
        beneficiary_address: document.getElementById("b_beneficiary_address").value,
        beneficiary_country: document.getElementById("b_beneficiary_country").value,
        beneficiary_bank_name: document.getElementById("b_beneficiary_bank_name").value,
        beneficiary_bank_address: document.getElementById("b_beneficiary_bank_address").value,
        beneficiary_bank_country: document.getElementById("b_beneficiary_bank_country").value,
        beneficiary_bank_swift: document.getElementById("b_beneficiary_bank_swift").value,
        intermediary_bank_name: document.getElementById("b_intermediary_bank_name").value,
        intermediary_bank_address: document.getElementById("b_intermediary_bank_address").value,
        intermediary_bank_swift: document.getElementById("b_intermediary_bank_swift").value
      };

      const r = await fetch(`/api/upsert/${rtype}`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      const data = await r.json();
      if(!data.ok){ alert("Notion error: " + (data.error||"")); return; }
      alert("Saved to Notion.");
      await loadOptions();
    }

    function currentForms(){
      const rem = {
        name: document.getElementById("r_name")?.value || "",
        account_no: document.getElementById("r_account_no")?.value || "",
        address: document.getElementById("r_address")?.value || "",
        phone: document.getElementById("r_phone")?.value || "",
        id_type: document.getElementById("r_id_type")?.value || "",
        id_value: document.getElementById("r_id_value")?.value || ""
      };
      const ben = {
        beneficiary_name: document.getElementById("b_beneficiary_name")?.value || "",
        beneficiary_account_number: document.getElementById("b_beneficiary_account_number")?.value || "",
        beneficiary_address: document.getElementById("b_beneficiary_address")?.value || "",
        beneficiary_country: document.getElementById("b_beneficiary_country")?.value || "",
        beneficiary_bank_name: document.getElementById("b_beneficiary_bank_name")?.value || "",
        beneficiary_bank_address: document.getElementById("b_beneficiary_bank_address")?.value || "",
        beneficiary_bank_country: document.getElementById("b_beneficiary_bank_country")?.value || "",
        beneficiary_bank_swift: document.getElementById("b_beneficiary_bank_swift")?.value || "",
        intermediary_bank_name: document.getElementById("b_intermediary_bank_name")?.value || "",
        intermediary_bank_address: document.getElementById("b_intermediary_bank_address")?.value || "",
        intermediary_bank_swift: document.getElementById("b_intermediary_bank_swift")?.value || ""
      };
      const extra = {
        date: document.getElementById("ttDate").value,
        currency: document.getElementById("ttCurrency").value,
        amount_figures: document.getElementById("ttAmount").value,
        charges: document.getElementById("ttCharges").value,
        account_to_be_debited_number_currency: document.getElementById("ttDebit").value,
        notes: document.getElementById("ttNotes").value
      };
      return {beneficiary: ben, remitter: rem, extra};
    }

    async function generateDoc(overwrite=false, out_path=null){
      const body = currentForms();
      body.extra = {...body.extra, overwrite, out_path};
      const r = await fetch("/generate", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
      const ct = r.headers.get("Content-Type") || "";
      if (overwrite || out_path) {
        const text = await r.text(); alert(text); return;
      }
      if (!r.ok || !ct.includes("officedocument")) {
        const err = await r.text(); alert("Generate failed: " + err); return;
      }
      const blob = await r.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "TT_Filled.docx"; document.body.appendChild(a);
      a.click(); a.remove(); window.URL.revokeObjectURL(url);
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      document.getElementById("remitterSelect").addEventListener("change", e => onSelect("remitter", e.target.value));
      document.getElementById("beneficiarySelect").addEventListener("change", e => onSelect("beneficiary", e.target.value));
      document.getElementById("newRemitterBtn").addEventListener("click", ()=> {
        const wrap = document.getElementById("remitterForm"); wrap.innerHTML=""; wrap.appendChild(remitterFields({}));
      });
      document.getElementById("newBeneficiaryBtn").addEventListener("click", ()=> {
        const wrap = document.getElementById("beneficiaryForm"); wrap.innerHTML=""; wrap.appendChild(beneficiaryFields({}));
      });
      document.getElementById("saveButtons").addEventListener("click", async ()=>{
        if(document.getElementById("r_name")) await upsert("remitter");
        if(document.getElementById("b_beneficiary_name")) await upsert("beneficiary");
      });
      document.getElementById("generateBtn").addEventListener("click", ()=> generateDoc(false, null));
      document.getElementById("overwriteBtn").addEventListener("click", ()=> generateDoc(true, null));
      await loadOptions();
    });
  </script>
</body>
</html>
